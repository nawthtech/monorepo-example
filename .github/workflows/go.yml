# .github/workflows/go.yml
# NawthTech CI/CD Pipeline for Go Backend + React Frontend
name: NawthTech CI/CD

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

env:
  GO_VERSION: '1.21'
  NODE_VERSION: '18.x'

jobs:
  # ÿßÿÆÿ™ÿ®ÿßÿ± Ÿàÿ®ŸÜÿßÿ° Backend (Go)
  backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: backend/go.sum

    - name: Verify Go modules
      run: |
        go mod download
        go mod verify
        echo "‚úÖ Go modules verified"

    - name: Run linting
      run: |
        # Install staticcheck if not present
        go install honnef.co/go/tools/cmd/staticcheck@latest
        staticcheck ./...
        echo "‚úÖ Code linting completed"

    - name: Run tests
      run: |
        go test -v -race ./... -coverprofile=coverage.out
        go tool cover -html=coverage.out -o coverage.html
        echo "‚úÖ Tests completed with coverage report"

    - name: Build Go binary
      run: |
        go build -v -o nawthtech-backend ./...
        file nawthtech-backend
        echo "‚úÖ Backend binary built successfully"

    - name: Security scan
      uses: golangci/golangci-lint-action@v3
      with:
        working-directory: ./backend
        version: latest

  # ÿßÿÆÿ™ÿ®ÿßÿ± Ÿàÿ®ŸÜÿßÿ° Frontend (React)
  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        npm ci --no-audit --no-fund
        echo "‚úÖ Frontend dependencies installed"

    - name: Run linting
      run: |
        npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings=0
        echo "‚úÖ ESLint completed"

    - name: Run tests
      run: |
        npm test -- --coverage --watchAll=false
        echo "‚úÖ Frontend tests completed"

    - name: Build frontend
      run: |
        npm run build
        ls -la dist/
        echo "‚úÖ Frontend built successfully"

    - name: Audit dependencies
      run: |
        npm audit --audit-level moderate
        echo "‚úÖ Security audit completed"

  # ÿßŸÑŸÜÿ¥ÿ± ÿ•ŸÑŸâ Railway (ŸÅŸÇÿ∑ ÿπŸÑŸâ main branch)
  deploy:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Railway CLI
      run: |
        curl -fsSL https://railway.app/install.sh | sh
        echo "$HOME/.railway/bin" >> $GITHUB_PATH

    - name: Deploy Backend to Railway
      working-directory: ./backend
      run: |
        echo "üöÄ Deploying NawthTech Backend..."
        
        railway login --ci ${{ secrets.RAILWAY_TOKEN }}
        
        # Link to specific project if ID is provided
        if [ -n "${{ secrets.RAILWAY_BACKEND_PROJECT_ID }}" ]; then
          railway link ${{ secrets.RAILWAY_BACKEND_PROJECT_ID }}
        fi
        
        # Deploy backend service
        railway up --service "${{ secrets.RAILWAY_BACKEND_SERVICE_NAME || 'nawthtech-backend' }}" --detach
        
        echo "‚úÖ Backend deployment initiated"
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: Wait for backend to be healthy
      run: |
        echo "‚è≥ Waiting for backend to be ready..."
        sleep 30
        
        BACKEND_URL="https://api.nawthtech.com"
        echo "üîç Checking backend health at: $BACKEND_URL/health"
        
        for i in {1..10}; do
          if curl -f -s "$BACKEND_URL/health" > /dev/null; then
            echo "‚úÖ Backend is healthy!"
            break
          else
            echo "‚è≥ Attempt $i: Backend not ready yet..."
            sleep 10
          fi
        done

    - name: Deploy Frontend to Railway
      working-directory: ./frontend
      run: |
        echo "üöÄ Deploying NawthTech Frontend..."
        
        railway login --ci ${{ secrets.RAILWAY_TOKEN }}
        
        # Link to specific project if ID is provided
        if [ -n "${{ secrets.RAILWAY_FRONTEND_PROJECT_ID }}" ]; then
          railway link ${{ secrets.RAILWAY_FRONTEND_PROJECT_ID }}
        fi
        
        # Deploy frontend service
        railway up --service "${{ secrets.RAILWAY_FRONTEND_SERVICE_NAME || 'nawthtech-frontend' }}" --detach
        
        echo "‚úÖ Frontend deployment initiated"
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: Run post-deployment tests
      run: |
        echo "üß™ Running post-deployment checks..."
        
        # Test backend API
        BACKEND_RESPONSE=$(curl -s "https://api.nawthtech.com/health" || echo "{}")
        echo "Backend Health: $BACKEND_RESPONSE"
        
        # Test frontend
        FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://nawthtech.com" || echo "000")
        echo "Frontend HTTP Status: $FRONTEND_STATUS"
        
        echo "‚úÖ Post-deployment checks completed"

    - name: Notify deployment status
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const { backend, frontend } = await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'deploy.yml',
            ref: 'main'
          });
          
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `üéØ **NawthTech Deployment Completed**\n\n` +
                  `**Services:**\n` +
                  `‚Ä¢ Backend: https://api.nawthtech.com\n` +
                  `‚Ä¢ Frontend: https://nawthtech.com\n` +
                  `**Commit:** ${context.sha.substring(0, 7)}\n` +
                  `**Triggered by:** @${context.actor}`
          });

  # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÖŸÜ ÿßŸÑÿ¨ŸàÿØÿ©
  quality:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: always()
    
    steps:
    - name: Quality Gate
      run: |
        echo "üìä NawthTech Quality Report"
        echo "==========================="
        echo "‚úÖ Backend: Go ${{ env.GO_VERSION }} - Tests & Build"
        echo "‚úÖ Frontend: Node ${{ env.NODE_VERSION }} - Tests & Build" 
        echo "‚úÖ Security: Code scanning & dependency audit"
        echo "‚úÖ Deployment: Railway integration ready"
        echo ""
        echo "üöÄ All quality checks passed!"
