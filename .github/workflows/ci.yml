name: Continuous Integration

on:
  push:
    branches: [main, master, develop, 'feature/**', 'bugfix/**']
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '**/*.log'
      - '**/.gitignore'
      - '**/.editorconfig'
  
  pull_request:
    branches: [main, master, develop]

env:
  NODE_VERSION: '20'
  WORKER_DIR: './worker'

jobs:
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKER_DIR }}/package-lock.json
          
      - name: Install dependencies
        run: |
          cd ${{ env.WORKER_DIR }}
          npm ci --audit=false
          
      - name: Run security audit
        run: |
          cd ${{ env.WORKER_DIR }}
          npm audit --audit-level=high || true
          
      - name: Check for outdated dependencies
        run: |
          cd ${{ env.WORKER_DIR }}
          npm outdated || true
          
      - name: Check package.json validity
        run: |
          cd ${{ env.WORKER_DIR }}
          npm pack --dry-run
          
      - name: Run size check
        run: |
          cd ${{ env.WORKER_DIR }}
          npx size-limit

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: Check for secrets in code
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: quality-gate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKER_DIR }}/package-lock.json
          
      - name: Install dependencies
        run: |
          cd ${{ env.WORKER_DIR }}
          npm ci --audit=false
          
      - name: Build for performance testing
        run: |
          cd ${{ env.WORKER_DIR }}
          npm run build
          
      - name: Run performance tests
        run: |
          cd ${{ env.WORKER_DIR }}
          npm run test:performance
          
      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: ${{ env.WORKER_DIR }}/performance-results/
          retention-days: 30

  dependency-update:
    name: Dependency Update Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKER_DIR }}/package-lock.json
          
      - name: Check for updates
        run: |
          cd ${{ env.WORKER_DIR }}
          npx npm-check-updates --target minor
          
      - name: Create PR for major updates
        if: failure()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'Dependency Updates Available'
          body: |
            ## Available Dependency Updates
            
            The following dependencies have updates available:
            
            ```bash
            # Run this to update:
            npx npm-check-updates -u && npm install
            ```
            
            **Note:** Review breaking changes before merging.
          branch: chore/dependency-updates
          base: develop

  monitor:
    name: Monitor Deployments
    runs-on: ubuntu-latest
    if: always()
    needs: [deploy-staging, deploy-production]
    
    steps:
      - name: Check deployment status
        run: |
          echo "Staging deployment: ${{ needs.deploy-staging.result }}"
          echo "Production deployment: ${{ needs.deploy-production.result }}"
          
      - name: Generate deployment report
        if: always()
        run: |
          echo "# Deployment Report" > report.md
          echo "## Summary" >> report.md
          echo "- **Timestamp:** $(date)" >> report.md
          echo "- **Commit:** ${{ github.sha }}" >> report.md
          echo "- **Branch:** ${{ github.ref }}" >> report.md
          echo "" >> report.md
          echo "## Job Results" >> report.md
          echo "| Job | Status |" >> report.md
          echo "|-----|--------|" >> report.md
          echo "| Quality Gate | ${{ needs.quality-gate.result }}" >> report.md
          echo "| Security Scan | ${{ needs.security-scan.result }}" >> report.md
          echo "| Staging Deployment | ${{ needs.deploy-staging.result }}" >> report.md
          echo "| Production Deployment | ${{ needs.deploy-production.result }}" >> report.md
          
      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: report.md
          retention-days: 90